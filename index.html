<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2C Smart Home</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-main: #ffffff;
            --accent-green: #32d74b;
            --accent-blue: #0a84ff;
            --accent-red: #ff453a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h2 { margin: 0; font-size: 28px; font-weight: 700; }

        .status-dot {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            background: #2c2c2e;
            font-weight: 600;
            transition: color 0.3s;
        }
        .status-on { color: var(--accent-green); }
        .status-off { color: var(--accent-red); }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px 20px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-left {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .icon { font-size: 26px; }

        /* iOS Style Toggle Switch */
        .switch { position: relative; display: inline-block; width: 54px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #39393d; transition: .3s; border-radius: 30px;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px;
            background-color: white; transition: .3s; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--accent-green); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* Voice Button Minimalist */
        .btn-voice {
            width: 100%;
            background: #2c2c2e;
            color: var(--accent-blue);
            border: none;
            padding: 18px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        .btn-voice:active { transform: scale(0.97); }
        .btn-voice.listening {
            color: var(--accent-red);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2>Ruangan</h2>
            <div id="status" class="status-dot status-off">‚óè Offline</div>
        </div>
        
        <div class="card">
            <div class="card-left"><span class="icon">üí°</span> Lampu</div>
            <label class="switch">
                <input type="checkbox" id="toggleLamp" onchange="handleToggle('LAMP', this)">
                <span class="slider"></span>
            </label>
        </div>

        <div class="card">
            <div class="card-left"><span class="icon">‚ùÑÔ∏è</span> Kipas</div>
            <label class="switch">
                <input type="checkbox" id="toggleFan" onchange="handleToggle('FAN', this)">
                <span class="slider"></span>
            </label>
        </div>

        <button id="btnVoice" class="btn-voice">üéôÔ∏è Kontrol Suara</button>
    </div>

    <script>
        const mqttServer = "broker.emqx.io";
        const mqttPort = 8084;
        const topicCmd  = "kontrol/ruangan/perintah";
        const topicStat = "kontrol/ruangan/status";
        const clientId = "WebClient-" + Math.random().toString(16).substr(2, 8);

        const client = new Paho.MQTT.Client(mqttServer, mqttPort, "/mqtt", clientId);
        const statusEl = document.getElementById("status");
        const toggleLamp = document.getElementById("toggleLamp");
        const toggleFan = document.getElementById("toggleFan");

        client.onConnectionLost = () => {
            statusEl.innerHTML = "‚óè Offline";
            statusEl.className = "status-dot status-off";
        };

        client.onMessageArrived = (message) => {
            const msg = message.payloadString;
            if (msg === "LAMP_ON") toggleLamp.checked = true;
            else if (msg === "LAMP_OFF") toggleLamp.checked = false;
            else if (msg === "FAN_ON") toggleFan.checked = true;
            else if (msg === "FAN_OFF") toggleFan.checked = false;
        };

        const options = {
            timeout: 3,
            useSSL: true,
            onSuccess: () => {
                statusEl.innerHTML = "‚óè Online";
                statusEl.className = "status-dot status-on";
                client.subscribe(topicStat);
            }
        };

        client.connect(options);

        function handleToggle(device, checkbox) {
            let command = "";
            if (device === 'LAMP') command = checkbox.checked ? "ONLAMP" : "OFFLAMP";
            if (device === 'FAN') command = checkbox.checked ? "ONFAN" : "OFFFAN";
            
            if (client.isConnected()) {
                const message = new Paho.MQTT.Message(command);
                message.destinationName = topicCmd;
                client.send(message);
            } else {
                checkbox.checked = !checkbox.checked;
            }
        }

        function sendCommand(cmd) {
            if (client.isConnected()) {
                const message = new Paho.MQTT.Message(cmd);
                message.destinationName = topicCmd;
                client.send(message);
            }
        }

        // Web Speech API
        const btnVoice = document.getElementById('btnVoice');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'id-ID'; 
            recognition.interimResults = false;

            btnVoice.addEventListener('click', () => {
                recognition.start();
                btnVoice.classList.add("listening");
                btnVoice.textContent = "Mendengarkan...";
            });

            recognition.onresult = (event) => {
                const hasil = event.results[0][0].transcript.toLowerCase();
                
                // Tampilkan teks sementara di dalam tombol
                btnVoice.textContent = `"${hasil}"`;
                setTimeout(() => { btnVoice.textContent = "üéôÔ∏è Kontrol Suara"; }, 3000);

                if (hasil.includes("nyalakan lampu")) {
                    toggleLamp.checked = true; sendCommand("ONLAMP");
                } else if (hasil.includes("matikan lampu")) {
                    toggleLamp.checked = false; sendCommand("OFFLAMP");
                } else if (hasil.includes("nyalakan kipas")) {
                    toggleFan.checked = true; sendCommand("ONFAN");
                } else if (hasil.includes("matikan kipas")) {
                    toggleFan.checked = false; sendCommand("OFFFAN");
                } else {
                    btnVoice.textContent = "Tidak dikenal";
                }
            };

            recognition.onspeechend = () => {
                recognition.stop();
                btnVoice.classList.remove("listening");
            };
            recognition.onerror = () => {
                btnVoice.classList.remove("listening");
                btnVoice.textContent = "üéôÔ∏è Kontrol Suara";
            };
        }
    </script>
</body>
</html>
