<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home - R2C</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-muted: #888888;
            --accent-blue: #007bff;
            --btn-voice: #333333;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 450px; }
        h2 { margin-bottom: 5px; font-weight: 600; letter-spacing: 1px; }
        .subtitle { color: var(--text-muted); font-size: 0.9em; margin-bottom: 30px; }

        #status {
            display: inline-block; padding: 8px 16px; background-color: #333;
            border-radius: 20px; font-size: 0.85em; font-weight: bold; margin-bottom: 30px;
        }
        .status-connected { color: #4cd137; }
        .status-disconnected { color: #e84118; }

        /* Card Layout */
        .device-card {
            background: var(--card-bg); padding: 20px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: space-between;
        }
        .device-info h3 { margin: 0 0 5px 0; font-size: 1.1em; text-align: left; }
        .device-info p { margin: 0; font-size: 0.8em; color: var(--text-muted); text-align: left; }

        /* Toggle Switch CSS */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #555; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Voice Control */
        .voice-section {
            background: var(--card-bg); padding: 25px 20px; border-radius: 12px;
            margin-top: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn-voice {
            background-color: var(--btn-voice); color: white; border: none; width: 100%;
            padding: 15px; font-size: 16px; border-radius: 50px; cursor: pointer; transition: 0.3s;
        }
        .btn-voice.listening { background-color: #dc3545; animation: pulse 1.5s infinite; }
        #transcript { margin-top: 15px; font-style: italic; color: var(--text-muted); font-size: 0.9em; min-height: 20px; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Smart Home</h2>
        <div class="subtitle">2-Way Feedback System</div>
        
        <div id="status" class="status-disconnected">üî¥ Terputus</div>
        
        <div class="device-card">
            <div class="device-info">
                <h3>üí° Lampu</h3>
                <p>Relay Channel 1</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="toggleLamp" onchange="handleToggle('LAMP', this)">
                <span class="slider"></span>
            </label>
        </div>

        <div class="device-card">
            <div class="device-info">
                <h3>‚ùÑÔ∏è Kipas</h3>
                <p>Relay Channel 2</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="toggleFan" onchange="handleToggle('FAN', this)">
                <span class="slider"></span>
            </label>
        </div>

        <div class="voice-section">
            <button id="btnVoice" class="btn-voice">üéôÔ∏è Sentuh untuk Bicara</button>
            <div id="transcript">Teks suara akan muncul di sini...</div>
        </div>
    </div>

    <script>
        const mqttServer = "broker.emqx.io";
        const mqttPort = 8084; // WSS Secure
        const topicCmd  = "kontrol/ruangan/perintah";
        const topicStat = "kontrol/ruangan/status";
        const clientId = "WebClient-" + Math.random().toString(16).substr(2, 8);

        const client = new Paho.MQTT.Client(mqttServer, mqttPort, "/mqtt", clientId);
        const statusEl = document.getElementById("status");
        const toggleLamp = document.getElementById("toggleLamp");
        const toggleFan = document.getElementById("toggleFan");

        client.onConnectionLost = (res) => {
            statusEl.innerHTML = "üî¥ Terputus";
            statusEl.className = "status-disconnected";
        };

        // KETIKA PESAN FEEDBACK DARI ESP32 MASUK
        client.onMessageArrived = (message) => {
            const msg = message.payloadString;
            console.log("Feedback masuk: " + msg);
            
            // Sinkronkan posisi toggle switch dengan keadaan asli ESP32
            if (msg === "LAMP_ON") toggleLamp.checked = true;
            else if (msg === "LAMP_OFF") toggleLamp.checked = false;
            else if (msg === "FAN_ON") toggleFan.checked = true;
            else if (msg === "FAN_OFF") toggleFan.checked = false;
        };

        const options = {
            timeout: 3,
            useSSL: true,
            onSuccess: () => {
                statusEl.innerHTML = "üü¢ Terhubung";
                statusEl.className = "status-connected";
                client.subscribe(topicStat); // Dengarkan feedback dari ESP32
            }
        };

        client.connect(options);

        // FUNGSI SAAT TOGGLE SWITCH DIKLIK MANUAL
        function handleToggle(device, checkbox) {
            let command = "";
            if (device === 'LAMP') command = checkbox.checked ? "ONLAMP" : "OFFLAMP";
            if (device === 'FAN') command = checkbox.checked ? "ONFAN" : "OFFFAN";
            
            if (client.isConnected()) {
                const message = new Paho.MQTT.Message(command);
                message.destinationName = topicCmd;
                client.send(message);
            } else {
                alert("Sistem belum terhubung ke Broker!");
                checkbox.checked = !checkbox.checked; // Kembalikan posisi jika gagal
            }
        }

        function sendCommand(cmd) {
            if (client.isConnected()) {
                const message = new Paho.MQTT.Message(cmd);
                message.destinationName = topicCmd;
                client.send(message);
            }
        }

        // --- Web Speech API ---
        const btnVoice = document.getElementById('btnVoice');
        const textTranscript = document.getElementById('transcript');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'id-ID'; 
            recognition.interimResults = false;

            btnVoice.addEventListener('click', () => {
                recognition.start();
                btnVoice.classList.add("listening");
                textTranscript.textContent = "Silakan bicara...";
            });

            recognition.onresult = (event) => {
                const hasil = event.results[0][0].transcript.toLowerCase();
                textTranscript.textContent = "Terdengar: \"" + hasil + "\"";

                if (hasil.includes("nyalakan lampu")) {
                    toggleLamp.checked = true; sendCommand("ONLAMP");
                } else if (hasil.includes("matikan lampu")) {
                    toggleLamp.checked = false; sendCommand("OFFLAMP");
                } else if (hasil.includes("nyalakan kipas")) {
                    toggleFan.checked = true; sendCommand("ONFAN");
                } else if (hasil.includes("matikan kipas")) {
                    toggleFan.checked = false; sendCommand("OFFFAN");
                } else {
                    textTranscript.textContent += " (Perintah tidak dikenal)";
                }
            };

            recognition.onspeechend = () => {
                recognition.stop();
                btnVoice.classList.remove("listening");
            };
            recognition.onerror = () => {
                btnVoice.classList.remove("listening");
            };
        }
    </script>
</body>
</html>
